$( document ).ready(function() {

	//Setting up search bar
    $('#packyakInventoryDashSearch').on('keyup', function(e) {
	    if ('' != this.value) {
	        var reg = new RegExp(this.value, 'i'); // case-insesitive

	        $('.table tbody').find('tr').each(function() {
	            var $me = $(this);
	            if (!$me.children('td').text().match(reg)) {
	                $me.hide();
	            } else {
	                $me.show();
	            }
	        });
	    } else {
	        $('.table tbody').find('tr').show();
	    }
	});

    //cancel on search bar
    $('.packyakCancelSearch').click(function() {
    	$('#packyakInventoryDashSearch').val('').keyup();
    });

	//Clicking on inventory and unit price number changes to textfield and if hit cancel, shows original inventory level
	$(".packyakUnitPrice").click(function() {
		$(this).addClass("hidden");
		$(this).next().removeClass("hidden");
	});

	$( ".packyakInventory" ).click(function() {
  		$(this).addClass("hidden");
  		$(this).next().removeClass("hidden");
	});

	$( ".packyakCancel" ).click(function() {
		$(this).siblings('.packyakInventoryText').addClass('hidden');
		$(this).siblings('.packyakInventory').removeClass('hidden');
		$(this).siblings('.packyakUnitPriceText').addClass('hidden');
		$(this).siblings('.packyakUnitPrice').removeClass('hidden');

	});

	//submit function that uses ajax request to update inventory for square and unit price
	$('.packyakSubmitButton').click(function() {
    	var newInventoryLevel = $(this).siblings('.packyakInventoryText').children().val();
    	var oldInventoryLevel = $(this).siblings('.packyakInventory').html();
    	var itemLocation = $(this).siblings('.packyakLocationSold').html();
    	var itemVariationID = $(this).siblings('.packyakInventoryItemID').html();
    	var updatedUnitPrice = $(this).siblings('.packyakUnitPriceText').children().val();
    	var oldUnitPrice = $(this).siblings('.packyakUnitPrice').html();

    	//saving the objects into variable to use after ajax request
    	var thatRowInventoryTextbox = $(this).siblings('.packyakInventoryText');
    	var thatRowInventory = $(this).siblings('.packyakInventory');
    	var thatRowUnitPriceTextbox = $(this).siblings('.packyakUnitPriceText');
    	var thatRowUnitPrice = $(this).siblings('.packyakUnitPrice');

    	$.ajaxSetup({
	        headers: {
	            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
	        }
		});

    	if($(this).siblings('.packyakInventoryText').is(':visible') || $(this).siblings('.packyakUnitPriceText').is(':visible')){
			if(updatedUnitPrice == oldUnitPrice && newInventoryLevel == oldInventoryLevel){
	    		alert('Please make a change in inventory or unit cost to submit.');
	    	}else if(newInventoryLevel < oldInventoryLevel || updatedUnitPrice < oldUnitPrice){
	    		var continueWithSelection = confirm('New inventory amount or unit price is lower than current levels. Continue?');
		    	if(continueWithSelection == true){
		    		var quantityDelta = newInventoryLevel - oldInventoryLevel;
		    		console.log(quantityDelta);
			    	$.ajax({
				        type: "POST",
				        url: './dashboard',
				        data: {'itemLocation': itemLocation,
				        	   'itemVariationID': itemVariationID,
				        	   'quantityDelta': quantityDelta,
				        	   'updatedUnitPrice': updatedUnitPrice
				    		  },
				        success: function(data) {
				        	//switching classes back to normal
						var responseData = $.parseJSON(data)
			            console.log(data);
			        	thatRowInventoryTextbox.addClass('hidden');
		           		thatRowInventory.html(responseData.itemVariationInventory);
		           		thatRowInventory.removeClass('hidden');
		           		thatRowInventory.parent().addClass('updateSuccess');
		           		thatRowUnitPriceTextbox.addClass('hidden');
		           		thatRowUnitPrice.html(responseData.itemVariationUnitPrice);
		           		thatRowUnitPrice.removeClass('hidden');
				           	console.log('this is the upper function');

				        }
				    })
		    	}else{
		    		console.log('Canceled request');
		    	}	
		    }else{	
		    	var quantityDelta = newInventoryLevel - oldInventoryLevel;
		    	console.log(quantityDelta);
		    	$.ajax({
			        type: "POST",
			        url: './dashboard',
			        data: {	
			        		'itemLocation': itemLocation,
			        	   'itemVariationID': itemVariationID,
			        	   'quantityDelta': quantityDelta,
			        	   'updatedUnitPrice': updatedUnitPrice
			    		  },
			        success: function(data) {
			            //switching classes back to normal
			            var responseData = $.parseJSON(data);
						var rawUnitCost = parseInt(responseData.itemVariationUnitPrice, 10)/100;
						var formattedUnitCost = '$' + rawUnitCost.toFixed(2).replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,");
			            console.log(data);
			        	thatRowInventoryTextbox.addClass('hidden');
		           		thatRowInventory.html(responseData.itemVariationInventory);
		           		thatRowInventory.removeClass('hidden');
		           		thatRowInventory.parent().addClass('updateSuccess');
		           		thatRowUnitPriceTextbox.addClass('hidden');
		           		thatRowUnitPrice.html(formattedUnitCost);
		           		thatRowUnitPrice.removeClass('hidden');


			           
			           console.log('Inventory updated');
			        },
			        error: function(ts) { console.log(ts.responseText) }
			    })
		    }
		}else{
			console.log('Please do something in order to submit');
		}
    });

	/*--------------------ADDING A PURCHASE ORDER IN DATABASE----------------------------*/
	//Changing the title of the modal so not to use 2 of them
	$('.packyakNewPOButton').click(function() {

		$('#myModal').find('.modal-title').html('New Purchase Order');
	});


	$('.packyakPurchaseOrderCreateButton').click(function() {
		var po_name = $('#newPurchaseOrderTitle').val();//
		var po_status = $('#purchaseOrderStatusSelect').val();//
		var po_vendor = $('#purchaseOrderVendorSelect').val();//
		var po_location = $('#purchaseOrderLocationSelect').val();//
		var po_invoice_number = $('#purchaseOrderInvoiceNumber').val();//
		var action = 'createPO';
    	$.ajaxSetup({
	        headers: {
	            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
	        }
		});

		$.ajax({
	        type: "POST",
	        url: './purchaseOrders',

	        data: {
	        		'action': action,
	        		'po_name': po_name,
	        	   'po_status': po_status,
	        	   'po_vendor': po_vendor,
	        	   'po_location': po_location,
	        	   'po_invoice_number': po_invoice_number
	    		  },
	        success: function(data) {
	        	console.log(data);
	           $('#myModal').modal('toggle');

	           var responseData = $.parseJSON(data);
	           
	           

	        },
	        error: function(ts) { console.log(ts.responseText) }
	    })
	});

	//adding an item to a purchase order
	$('.packyakPurchaseOrderListItem').click(function(){
		var action = 'addToPO';
		var selectedPurchaseOrder = $(this).html();
		var itemVariationID = $(this).parents('.packYakItemFeedRow').find('.packyakInventoryItemID').html();
		var packyakPurchaseOrderID = $(this).siblings('.packyakPurchaseOrderID').html();
		console.log(packyakPurchaseOrderID);
		
		
		    	$.ajaxSetup({
	        headers: {
	            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
	        }
		});

		
        data =  {'action': action,
        		 'selectedPurchaseOrder': selectedPurchaseOrder,
        		 'itemVariationID': itemVariationID,
        		 'packyakPurchaseOrderID': packyakPurchaseOrderID
    			};

       		$.ajax({
	        type: "POST",
	        url: './purchaseOrders',

	        data: data,
	        success: function(data) {
	        	var responseData = $.parseJSON(data);
	        },
	        error: function(ts) { console.log(ts.responseText) }
	    })
	});

	//removing item from purchase order
	$('.packyakRemoveFromPO').click(function(){
		var action = 'removeItemFromPO';
		var packyakPurchaseOrderID = $(this).parents('.packyakPOHeader').children().children('.pypoid').html();
		var itemVariationID = $(this).parents('.packyakPOItemListItem').children('.poitemid').html();
		var successCancelRow = $(this).parents('.packyakPOItemListItem');
		
		
		if(confirm('Are you sure you want to remove this item?')){
	        data =  {'action': action,
	        		 'itemVariationID': itemVariationID,
	        		 'packyakPurchaseOrderID': packyakPurchaseOrderID
	    			};

	       		$.ajax({
		        type: "POST",
		        url: './purchaseOrders',

		        data: data,
		        success: function(data) {
		        	successCancelRow.hide();
		        },
		        error: function(ts) { console.log(ts.responseText) }
		    })
		}
	});

	//editing purchase order details
	$('.packyackPOEdit').click(function(){
		$('#myModal').modal('toggle');
		$('#myModal').find('.modal-title').html('Edit Purchase Order');
		var selectedStatus = $(this).parents('.packyakPOHeader').find('.packYakPOStatus').text();
		var selectedVendor = $(this).parents('.packyakPOHeader').find('.packYakPOVendor').text();
		var selectedLocation = $(this).parents('.packyakPOHeader').find('.packYakPOLocation').text();

		console.log($(this).parents('.packyakPOHeader').find('.packYakPOName').text());

		$('#newPurchaseOrderTitle').val($(this).parents('.packyakPOHeader').find('.packYakPOName').text());
		//--Invoice Number not yet showing on the main status-- $('#purchaseOrderInvoiceNumber').val($(this).parents('.packyakPOHeader').find('.packYakPOInvoice').text());
		$("#purchaseOrderLocationSelect option[value='selectedLocation']").val(selectedLocation);
		$("#purchaseOrderVendorSelect option[value='selectedVendor']").val(selectedVendor);
		$("#purchaseOrderStatusSelect option[value='selectedStatus']").val(selectedStatus);
	});

	//purchase order create new item and send data for new record and prime for square upload
	$('.packyakCreateNewItemButton').click(function(){
		var action = 'createNewItem';
		var newItemOject = {newItemCategory: $('.newItemForm').find('#createNewItemCategory').val(),
							newItemName: $('.newItemForm').find('#createNewItemName').val(),
							newItemVariation: $('.newItemForm').find('#createNewItemVariation').val(),
							newItemSku: $('.newItemForm').find('#createNewItemSku').val(),
							newItemInventoryLevel: $('.newItemForm').find('#createNewItemInventoryLevel').val(),
							newItemInventoryAlert: $('.newItemForm').find('#createNewItemInventoryAlert').val(),
							newItemPriceSold: $('.newItemForm').find('#createNewItemPrice').val(),
							newItemUnitCost: $('.newItemForm').find('#createNewItemUnitCost').val()
							};
		var jsonNewItemObject = JSON.stringify( newItemOject );

		console.log(newItemOject);
		$.ajaxSetup({
	        headers: {
	            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
	        }
		});

		$.ajax({
	        type: "POST",
	        url: './purchaseOrders',

	        data: {'action': action, 'data': jsonNewItemObject},
	        success: function(data) {
	        	//var responseData = $.parseJSON(data);
	        	console.log(data);
	        },
	        error: function(ts) { console.log(ts.responseText) }
	    })

		
		//console.log(json);
	});
});