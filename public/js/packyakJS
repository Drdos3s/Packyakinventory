$( document ).ready(function() {

	//Setting up search bar
    $('#packyakInventoryDashSearch').on('keyup', function(e) {
	    if ('' != this.value) {
	        var reg = new RegExp(this.value, 'i'); // case-insesitive

	        $('.table tbody').find('tr').each(function() {
	            var $me = $(this);
	            if (!$me.children('td').text().match(reg)) {
	                $me.hide();
	            } else {
	                $me.show();
	            }
	        });
	    } else {
	        $('.table tbody').find('tr').show();
	    }
	});

    //cancel on search bar
    $('.packyakCancelSearch').click(function() {
    	$('#packyakInventoryDashSearch').val('').keyup();
    });

	//Clicking on inventory number changes to textfield and if hit cancel, shows original inventory level
	$( ".packyakInventory" ).click(function() {
  		$(this).addClass("hidden");
  		$(this).next().removeClass("hidden");
	});

	$( ".packyakCancel" ).click(function() {
		$(this).siblings('.packyakInventoryText').addClass('hidden');
		$(this).siblings('.packyakInventory').removeClass('hidden');

	});

	//submit function that uses ajax request to update inventory for square
	$('.packyakSubmitButton').click(function() {
    	var newInventoryLevel = $(this).siblings('.packyakInventoryText').children().val();
    	var oldInventoryLevel = $(this).siblings('.packyakInventory').html();
    	var itemLocation = $(this).siblings('.packyakLocationSold').html();
    	var itemVariationID = $(this).siblings('.packyakInventoryItemID').html();

    	//saving the objects into variable to use after ajax request
    	var thatRowTextbox = $(this).siblings('.packyakInventoryText');
    	var thatRowInventory = $(this).siblings('.packyakInventory');

    	$.ajaxSetup({
	        headers: {
	            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
	        }
		});

    	if($(this).siblings('.packyakInventoryText').is(':visible')){
			if(newInventoryLevel == oldInventoryLevel){
	    		alert('Please make a change in inventory level to submit.');
	    	}else if(newInventoryLevel < oldInventoryLevel){
	    		var continueWithSelection = confirm('New inventory level is lower than old inventory. Continue?');
		    	if(continueWithSelection == true){
		    		var quantityDelta = newInventoryLevel - oldInventoryLevel;
			    	$.ajax({
				        type: "POST",
				        url: './dashboard',
				        data: {'itemLocation': itemLocation,
				        	   'itemVariationID': itemVariationID,
				        	   'quantityDelta': quantityDelta
				    		  },
				        success: function(data) {
				        	thatRowTextbox.addClass('hidden');
			           		thatRowInventory.html(data);
			           		thatRowInventory.removeClass('hidden');
			           		thatRowInventory.parent().addClass('updateSuccess');
				           	console.log('this is the upper function');
				        }
				    })
		    	}else{
		    		console.log('Canceled request');
		    	}	
		    }else{	
		    	var quantityDelta = newInventoryLevel - oldInventoryLevel;
		    	$.ajax({
			        type: "POST",
			        url: './dashboard',
			        data: {'itemLocation': itemLocation,
			        	   'itemVariationID': itemVariationID,
			        	   'quantityDelta': quantityDelta
			    		  },
			        success: function(data) {
			           thatRowTextbox.addClass('hidden');
			           thatRowInventory.html(data);
			           thatRowInventory.removeClass('hidden');
			           thatRowInventory.parent().addClass('updateSuccess');
			           
			           console.log('Inventory updated');
			        },
			        error: function(ts) { console.log(ts.responseText) }
			    })
		    }
		}else{
			console.log('This item new inventory text is not visible. ')
		}
    });

	/*--------------------ADDING ITEM TO A PURCHASE ORDER IN DATABASE----------------------------*/
	$('.packyakPurchaseOrderCreateButton').click(function() {
		var po_name = 'this is a test';//
		var po_status = 'this is a test';//
		var po_vendor = 'this is a test';//
		var po_location = 'this is a test';//
		var po_invoice_number = 'this is a test';//


    	$.ajaxSetup({
	        headers: {
	            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
	        }
		});

		$.ajax({
	        type: "POST",
	        url: './purchaseOrders',
	        data: {'po_name': po_name,
	        	   'po_status': po_status,
	        	   'po_vendor': po_vendor,
	        	   'po_location': po_location,
	        	   'po_invoice_number': po_invoice_number
	    		  },
	        success: function(data) {
	           console.log(data);
	           console.log('New Purchase Order Created');
	        },
	        error: function(ts) { console.log(ts.responseText) }
	    })
	});
});